<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Compression Test - Limud AI</title>
    <style>
        :root {
            --color-primary: #3498db;
            --color-primaryHover: #2980b9;
            --color-success: #27ae60;
            --color-danger: #e74c3c;
            --color-warning: #f39c12;
            --color-text: #2c3e50;
            --color-textSecondary: #7f8c8d;
            --color-surface: #ffffff;
            --color-surfaceElevated: #f8f9fa;
            --color-border: #dee2e6;
            --color-shadowLight: rgba(0, 0, 0, 0.1);
            --radius-sm: 4px;
            --radius-md: 8px;
            --transition-fast: all 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f6fa;
            color: var(--color-text);
            line-height: 1.6;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--color-surface);
            border-radius: var(--radius-md);
            padding: 2rem;
            box-shadow: 0 2px 8px var(--color-shadowLight);
        }

        h1 {
            color: var(--color-primary);
            margin-bottom: 2rem;
            text-align: center;
        }

        .test-section {
            background: var(--color-surfaceElevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .test-section h2 {
            color: var(--color-text);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-input {
            margin: 1rem 0;
        }

        .file-input input[type="file"] {
            padding: 0.5rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            background: var(--color-surface);
        }

        .compression-controls {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin: 1rem 0;
        }

        .quality-slider {
            margin: 1rem 0;
        }

        .quality-slider input[type="range"] {
            width: 100%;
            margin: 0.5rem 0;
        }

        .test-button {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 1rem;
            transition: var(--transition-fast);
            margin: 0.5rem;
        }

        .test-button:hover {
            background: var(--color-primaryHover);
        }

        .test-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .results {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin: 1rem 0;
            min-height: 100px;
        }

        .result-item {
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-left: 4px solid var(--color-primary);
            background: var(--color-surfaceElevated);
        }

        .success {
            border-left-color: var(--color-success);
            background: #d5f4e6;
        }

        .error {
            border-left-color: var(--color-danger);
            background: #fadbd8;
        }

        .warning {
            border-left-color: var(--color-warning);
            background: #fff3cd;
        }

        .file-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }

        .file-info {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: 1rem;
        }

        .file-info h4 {
            margin-bottom: 0.5rem;
            color: var(--color-primary);
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--color-border);
            border-radius: var(--radius-sm);
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-primary);
            transition: width 0.3s ease;
        }

        .media-preview {
            margin: 1rem 0;
            text-align: center;
        }

        .media-preview audio,
        .media-preview video,
        .media-preview img {
            max-width: 100%;
            border-radius: var(--radius-sm);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .stat-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--color-primary);
        }

        .stat-label {
            color: var(--color-textSecondary);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóúÔ∏è Media Compression Test</h1>
        
        <div class="test-section">
            <h2>üéµ Audio Compression Test</h2>
            <div class="file-input">
                <label for="audio-file">Select Audio File:</label>
                <input type="file" id="audio-file" accept="audio/*" />
            </div>
            
            <div class="compression-controls">
                <h3>Compression Settings</h3>
                <div class="quality-slider">
                    <label for="audio-quality">Quality: <span id="audio-quality-value">0.7</span></label>
                    <input type="range" id="audio-quality" min="0.3" max="0.9" step="0.1" value="0.7" />
                </div>
                <button class="test-button" id="compress-audio">Compress Audio</button>
            </div>
            
            <div class="results" id="audio-results">
                <p>Select an audio file and click "Compress Audio" to test compression.</p>
            </div>
        </div>

        <div class="test-section">
            <h2>üé¨ Video Compression Test</h2>
            <div class="file-input">
                <label for="video-file">Select Video File:</label>
                <input type="file" id="video-file" accept="video/*" />
            </div>
            
            <div class="compression-controls">
                <h3>Compression Settings</h3>
                <div class="quality-slider">
                    <label for="video-quality">Quality: <span id="video-quality-value">0.7</span></label>
                    <input type="range" id="video-quality" min="0.3" max="0.9" step="0.1" value="0.7" />
                </div>
                <button class="test-button" id="compress-video">Compress Video</button>
            </div>
            
            <div class="results" id="video-results">
                <p>Select a video file and click "Compress Video" to test compression.</p>
            </div>
        </div>

        <div class="test-section">
            <h2>üñºÔ∏è Image Compression Test</h2>
            <div class="file-input">
                <label for="image-file">Select Image File:</label>
                <input type="file" id="image-file" accept="image/*" />
            </div>
            
            <div class="compression-controls">
                <h3>Compression Settings</h3>
                <div class="quality-slider">
                    <label for="image-quality">Quality: <span id="image-quality-value">0.7</span></label>
                    <input type="range" id="image-quality" min="0.3" max="0.9" step="0.1" value="0.7" />
                </div>
                <button class="test-button" id="compress-image">Compress Image</button>
            </div>
            
            <div class="results" id="image-results">
                <p>Select an image file and click "Compress Image" to test compression.</p>
            </div>
        </div>

        <div class="test-section">
            <h2>üìä Compression Statistics</h2>
            <div class="stats-grid" id="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-files">0</div>
                    <div class="stat-label">Files Compressed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-savings">0 MB</div>
                    <div class="stat-label">Total Space Saved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-compression">0%</div>
                    <div class="stat-label">Average Compression</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="processing-time">0s</div>
                    <div class="stat-label">Total Processing Time</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import compression utilities (simulated for testing)
        const compressionUtils = {
            // Audio compression using Web Audio API
            compressAudio: async (file, quality = 0.7) => {
                return new Promise((resolve, reject) => {
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const fileReader = new FileReader();
                        
                        fileReader.onload = async (e) => {
                            try {
                                const arrayBuffer = e.target.result;
                                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                                
                                // Create offline context for compression
                                const sampleRate = Math.floor(audioBuffer.sampleRate * quality);
                                const offlineContext = new OfflineAudioContext(
                                    audioBuffer.numberOfChannels,
                                    audioBuffer.duration * sampleRate,
                                    sampleRate
                                );
                                
                                const source = offlineContext.createBufferSource();
                                source.buffer = audioBuffer;
                                source.connect(offlineContext.destination);
                                source.start();
                                
                                const compressedBuffer = await offlineContext.startRendering();
                                
                                // Convert to WAV format with reduced quality
                                const wavBlob = audioBufferToWav(compressedBuffer, quality);
                                
                                const compressedFile = new File([wavBlob], file.name.replace(/\.[^/.]+$/, '.wav'), {
                                    type: 'audio/wav',
                                    lastModified: Date.now()
                                });
                                
                                resolve(compressedFile);
                            } catch (error) {
                                console.error('Audio compression error:', error);
                                reject(error);
                            }
                        };
                        
                        fileReader.onerror = reject;
                        fileReader.readAsArrayBuffer(file);
                    } catch (error) {
                        console.error('Audio compression setup error:', error);
                        reject(error);
                    }
                });
            },

            // Video compression using canvas and MediaRecorder
            compressVideo: async (file, quality = 0.7) => {
                return new Promise((resolve, reject) => {
                    try {
                        const video = document.createElement('video');
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        video.onloadedmetadata = () => {
                            // Reduce dimensions based on quality
                            const scale = Math.sqrt(quality);
                            canvas.width = Math.floor(video.videoWidth * scale);
                            canvas.height = Math.floor(video.videoHeight * scale);
                            
                            // Set up MediaRecorder for compression
                            const stream = canvas.captureStream(30);
                            const mediaRecorder = new MediaRecorder(stream, {
                                mimeType: 'video/webm;codecs=vp9',
                                videoBitsPerSecond: Math.floor(1000000 * quality)
                            });
                            
                            const chunks = [];
                            
                            mediaRecorder.ondataavailable = (event) => {
                                if (event.data.size > 0) {
                                    chunks.push(event.data);
                                }
                            };
                            
                            mediaRecorder.onstop = () => {
                                const compressedBlob = new Blob(chunks, { type: 'video/webm' });
                                const compressedFile = new File([compressedBlob], file.name.replace(/\.[^/.]+$/, '.webm'), {
                                    type: 'video/webm',
                                    lastModified: Date.now()
                                });
                                resolve(compressedFile);
                            };
                            
                            mediaRecorder.onerror = reject;
                            
                            // Start recording
                            mediaRecorder.start();
                            
                            // Draw video frames to canvas
                            const drawFrame = () => {
                                if (!video.paused && !video.ended) {
                                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                                    requestAnimationFrame(drawFrame);
                                } else {
                                    mediaRecorder.stop();
                                }
                            };
                            
                            video.play();
                            drawFrame();
                        };
                        
                        video.onerror = reject;
                        video.src = URL.createObjectURL(file);
                    } catch (error) {
                        console.error('Video compression error:', error);
                        reject(error);
                    }
                });
            },

            // Image compression using canvas
            compressImage: async (file, quality = 0.7) => {
                return new Promise((resolve, reject) => {
                    try {
                        const img = new Image();
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        img.onload = () => {
                            // Reduce dimensions based on quality
                            const scale = Math.sqrt(quality);
                            canvas.width = Math.floor(img.width * scale);
                            canvas.height = Math.floor(img.height * scale);
                            
                            // Draw and compress
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            
                            canvas.toBlob((blob) => {
                                if (blob) {
                                    const compressedFile = new File([blob], file.name, {
                                        type: 'image/jpeg',
                                        lastModified: Date.now()
                                    });
                                    resolve(compressedFile);
                                } else {
                                    reject(new Error('Failed to compress image'));
                                }
                            }, 'image/jpeg', quality);
                        };
                        
                        img.onerror = reject;
                        img.src = URL.createObjectURL(file);
                    } catch (error) {
                        console.error('Image compression error:', error);
                        reject(error);
                    }
                });
            }
        };

        // Convert AudioBuffer to WAV blob
        function audioBufferToWav(buffer, quality = 0.7) {
            const length = buffer.length;
            const numberOfChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            
            const arrayBuffer = new ArrayBuffer(44 + length * numberOfChannels * 2);
            const view = new DataView(arrayBuffer);
            
            // WAV header
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length * numberOfChannels * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numberOfChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numberOfChannels * 2, true);
            view.setUint16(32, numberOfChannels * 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, length * numberOfChannels * 2, true);
            
            // Convert float samples to 16-bit PCM
            let offset = 44;
            for (let i = 0; i < length; i++) {
                for (let channel = 0; channel < numberOfChannels; channel++) {
                    const sample = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));
                    view.setInt16(offset, sample * 0x7FFF, true);
                    offset += 2;
                }
            }
            
            return new Blob([arrayBuffer], { type: 'audio/wav' });
        }

        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getCompressionRatio(originalSize, compressedSize) {
            if (originalSize === 0) return 0;
            return Math.round((1 - compressedSize / originalSize) * 100);
        }

        function addResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const resultItem = document.createElement('div');
            resultItem.className = `result-item ${type}`;
            resultItem.innerHTML = message;
            container.appendChild(resultItem);
            container.scrollTop = container.scrollHeight;
        }

        function createFileComparison(original, compressed) {
            const compressionRatio = getCompressionRatio(original.size, compressed.size);
            const savings = original.size - compressed.size;
            
            return `
                <div class="file-comparison">
                    <div class="file-info">
                        <h4>Original File</h4>
                        <p><strong>Name:</strong> ${original.name}</p>
                        <p><strong>Size:</strong> ${formatFileSize(original.size)}</p>
                        <p><strong>Type:</strong> ${original.type}</p>
                    </div>
                    <div class="file-info">
                        <h4>Compressed File</h4>
                        <p><strong>Name:</strong> ${compressed.name}</p>
                        <p><strong>Size:</strong> ${formatFileSize(compressed.size)}</p>
                        <p><strong>Type:</strong> ${compressed.type}</p>
                        <p><strong>Savings:</strong> ${formatFileSize(savings)} (${compressionRatio}%)</p>
                    </div>
                </div>
            `;
        }

        // Statistics tracking
        let stats = {
            totalFiles: 0,
            totalSavings: 0,
            totalCompressionRatio: 0,
            totalProcessingTime: 0
        };

        function updateStats(originalSize, compressedSize, processingTime) {
            stats.totalFiles++;
            stats.totalSavings += (originalSize - compressedSize);
            stats.totalCompressionRatio += getCompressionRatio(originalSize, compressedSize);
            stats.totalProcessingTime += processingTime;

            document.getElementById('total-files').textContent = stats.totalFiles;
            document.getElementById('total-savings').textContent = formatFileSize(stats.totalSavings);
            document.getElementById('avg-compression').textContent = Math.round(stats.totalCompressionRatio / stats.totalFiles) + '%';
            document.getElementById('processing-time').textContent = (stats.totalProcessingTime / 1000).toFixed(1) + 's';
        }

        // Event listeners
        document.getElementById('audio-quality').addEventListener('input', (e) => {
            document.getElementById('audio-quality-value').textContent = e.target.value;
        });

        document.getElementById('video-quality').addEventListener('input', (e) => {
            document.getElementById('video-quality-value').textContent = e.target.value;
        });

        document.getElementById('image-quality').addEventListener('input', (e) => {
            document.getElementById('image-quality-value').textContent = e.target.value;
        });

        // Audio compression test
        document.getElementById('compress-audio').addEventListener('click', async () => {
            const fileInput = document.getElementById('audio-file');
            const quality = parseFloat(document.getElementById('audio-quality').value);
            
            if (!fileInput.files[0]) {
                addResult('audio-results', 'Please select an audio file first.', 'warning');
                return;
            }

            const file = fileInput.files[0];
            const button = document.getElementById('compress-audio');
            
            button.disabled = true;
            button.textContent = 'Compressing...';
            
            try {
                const startTime = Date.now();
                addResult('audio-results', `Starting compression of ${file.name}...`, 'info');
                
                const compressedFile = await compressionUtils.compressAudio(file, quality);
                const processingTime = Date.now() - startTime;
                
                const comparison = createFileComparison(file, compressedFile);
                addResult('audio-results', comparison, 'success');
                addResult('audio-results', `‚úÖ Audio compression completed in ${(processingTime / 1000).toFixed(1)}s`, 'success');
                
                updateStats(file.size, compressedFile.size, processingTime);
                
                // Create download link
                const url = URL.createObjectURL(compressedFile);
                const downloadLink = `<a href="${url}" download="${compressedFile.name}">Download Compressed Audio</a>`;
                addResult('audio-results', downloadLink, 'info');
                
            } catch (error) {
                addResult('audio-results', `‚ùå Audio compression failed: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Compress Audio';
            }
        });

        // Video compression test
        document.getElementById('compress-video').addEventListener('click', async () => {
            const fileInput = document.getElementById('video-file');
            const quality = parseFloat(document.getElementById('video-quality').value);
            
            if (!fileInput.files[0]) {
                addResult('video-results', 'Please select a video file first.', 'warning');
                return;
            }

            const file = fileInput.files[0];
            const button = document.getElementById('compress-video');
            
            button.disabled = true;
            button.textContent = 'Compressing...';
            
            try {
                const startTime = Date.now();
                addResult('video-results', `Starting compression of ${file.name}...`, 'info');
                
                const compressedFile = await compressionUtils.compressVideo(file, quality);
                const processingTime = Date.now() - startTime;
                
                const comparison = createFileComparison(file, compressedFile);
                addResult('video-results', comparison, 'success');
                addResult('video-results', `‚úÖ Video compression completed in ${(processingTime / 1000).toFixed(1)}s`, 'success');
                
                updateStats(file.size, compressedFile.size, processingTime);
                
                // Create download link
                const url = URL.createObjectURL(compressedFile);
                const downloadLink = `<a href="${url}" download="${compressedFile.name}">Download Compressed Video</a>`;
                addResult('video-results', downloadLink, 'info');
                
            } catch (error) {
                addResult('video-results', `‚ùå Video compression failed: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Compress Video';
            }
        });

        // Image compression test
        document.getElementById('compress-image').addEventListener('click', async () => {
            const fileInput = document.getElementById('image-file');
            const quality = parseFloat(document.getElementById('image-quality').value);
            
            if (!fileInput.files[0]) {
                addResult('image-results', 'Please select an image file first.', 'warning');
                return;
            }

            const file = fileInput.files[0];
            const button = document.getElementById('compress-image');
            
            button.disabled = true;
            button.textContent = 'Compressing...';
            
            try {
                const startTime = Date.now();
                addResult('image-results', `Starting compression of ${file.name}...`, 'info');
                
                const compressedFile = await compressionUtils.compressImage(file, quality);
                const processingTime = Date.now() - startTime;
                
                const comparison = createFileComparison(file, compressedFile);
                addResult('image-results', comparison, 'success');
                addResult('image-results', `‚úÖ Image compression completed in ${(processingTime / 1000).toFixed(1)}s`, 'success');
                
                updateStats(file.size, compressedFile.size, processingTime);
                
                // Create download link and preview
                const url = URL.createObjectURL(compressedFile);
                const downloadLink = `<a href="${url}" download="${compressedFile.name}">Download Compressed Image</a>`;
                const preview = `<div class="media-preview"><img src="${url}" alt="Compressed Image" style="max-width: 300px;"></div>`;
                addResult('image-results', downloadLink + preview, 'info');
                
            } catch (error) {
                addResult('image-results', `‚ùå Image compression failed: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Compress Image';
            }
        });

        // Initialize
        console.log('Media Compression Test initialized');
    </script>
</body>
</html>
